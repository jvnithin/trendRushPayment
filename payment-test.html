<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Payment API Test</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .payment-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #3399cc;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-cards {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .test-cards h3 {
            margin-top: 0;
        }
        .test-cards code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üáÆüá≥ Indian Payment API Test</h1>
        
        <div class="test-cards">
            <h3>üß™ Test Cards (Use these for testing)</h3>
            <p><strong>Visa:</strong> <code>4111111111111111</code></p>
            <p><strong>Mastercard:</strong> <code>5555555555554444</code></p>
            <p><strong>Expiry:</strong> Any future date (e.g., 12/25)</p>
            <p><strong>CVV:</strong> Any 3 digits (e.g., 123)</p>
        </div>

        <div class="payment-section">
            <h3>üí≥ Card Payment Test</h3>
            <button onclick="createCardPayment()" id="cardBtn">Pay ‚Çπ100 (Card)</button>
            <div id="cardStatus"></div>
        </div>

        <div class="payment-section">
            <h3>üì± UPI Payment Test</h3>
            <button onclick="createUPIPayment()" id="upiBtn">Pay ‚Çπ200 (UPI)</button>
            <div id="upiStatus"></div>
        </div>

        <div class="payment-section">
            <h3>üí∞ Cash on Delivery Test</h3>
            <button onclick="createCODPayment()" id="codBtn">Pay ‚Çπ500 (COD)</button>
            <div id="codStatus"></div>
        </div>

        <div class="payment-section">
            <h3>üèõÔ∏è GST Calculation Test</h3>
            <button onclick="testGSTCalculation()" id="gstBtn">Calculate GST</button>
            <div id="gstStatus"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000';
        
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            button.disabled = loading;
            button.textContent = loading ? 'Processing...' : button.textContent.replace('Processing...', '');
        }

        async function createCardPayment() {
            setButtonLoading('cardBtn', true);
            showStatus('cardStatus', 'Creating payment...', 'info');
            
            try {
                // Step 1: Create payment
                const response = await fetch(`${API_BASE}/api/payments/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 100,
                        currency: 'INR',
                        paymentMethod: 'card',
                        orderId: 'CARD_TEST_' + Date.now(),
                        userId: 'user_001',
                        customerPhone: '+919876543210',
                        customerEmail: 'test@example.com',
                        customerName: 'Test User',
                        billingAddress: {
                            name: 'Test User',
                            street: '123 Test St',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400001',
                            country: 'India'
                        },
                        shippingAddress: {
                            name: 'Test User',
                            street: '123 Test St',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400001',
                            country: 'India',
                            phone: '+919876543210'
                        }
                    })
                });
                
                const paymentData = await response.json();
                
                if (paymentData.success) {
                    showStatus('cardStatus', 'Payment created! Opening Razorpay checkout...', 'success');
                    
                    // Step 2: Open Razorpay checkout
                    const options = {
                        key: paymentData.data.key,
                        amount: paymentData.data.amount * 100, // Convert to paise
                        currency: paymentData.data.currency,
                        name: 'Indian Payment API Test',
                        description: 'Test Card Payment',
                        order_id: paymentData.data.razorpayOrderId,
                        handler: function (response) {
                            // Step 3: Payment successful - confirm with backend
                            confirmPayment(paymentData.data.paymentId, response, 'cardStatus');
                        },
                        prefill: {
                            name: 'Test User',
                            email: 'test@example.com',
                            contact: '+919876543210'
                        },
                        theme: {
                            color: '#3399cc'
                        },
                        modal: {
                            ondismiss: function() {
                                showStatus('cardStatus', 'Payment cancelled by user', 'error');
                            }
                        }
                    };
                    
                    const rzp = new Razorpay(options);
                    rzp.open();
                    
                } else {
                    showStatus('cardStatus', `Payment creation failed: ${paymentData.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('cardStatus', 'Error: ' + error.message, 'error');
            } finally {
                setButtonLoading('cardBtn', false);
            }
        }

        async function createUPIPayment() {
            setButtonLoading('upiBtn', true);
            showStatus('upiStatus', 'Creating UPI payment...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/payments/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 200,
                        currency: 'INR',
                        paymentMethod: 'upi',
                        orderId: 'UPI_TEST_' + Date.now(),
                        userId: 'user_002',
                        customerPhone: '+919876543210',
                        customerEmail: 'test@example.com',
                        customerName: 'Test User',
                        billingAddress: {
                            name: 'Test User',
                            street: '123 Test St',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400001',
                            country: 'India'
                        },
                        shippingAddress: {
                            name: 'Test User',
                            street: '123 Test St',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400001',
                            country: 'India',
                            phone: '+919876543210'
                        }
                    })
                });
                
                const paymentData = await response.json();
                
                if (paymentData.success) {
                    showStatus('upiStatus', 'UPI payment created! Opening Razorpay checkout...', 'success');
                    
                    const options = {
                        key: paymentData.data.key,
                        amount: paymentData.data.amount * 100,
                        currency: paymentData.data.currency,
                        name: 'Indian Payment API Test',
                        description: 'Test UPI Payment',
                        order_id: paymentData.data.razorpayOrderId,
                        handler: function (response) {
                            confirmPayment(paymentData.data.paymentId, response, 'upiStatus');
                        },
                        prefill: {
                            name: 'Test User',
                            email: 'test@example.com',
                            contact: '+919876543210'
                        },
                        theme: {
                            color: '#3399cc'
                        },
                        modal: {
                            ondismiss: function() {
                                showStatus('upiStatus', 'UPI payment cancelled by user', 'error');
                            }
                        }
                    };
                    
                    const rzp = new Razorpay(options);
                    rzp.open();
                    
                } else {
                    showStatus('upiStatus', `UPI payment creation failed: ${paymentData.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('upiStatus', 'Error: ' + error.message, 'error');
            } finally {
                setButtonLoading('upiBtn', false);
            }
        }

        async function createCODPayment() {
            setButtonLoading('codBtn', true);
            showStatus('codStatus', 'Creating Cash on Delivery order...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/payments/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 500,
                        currency: 'INR',
                        paymentMethod: 'cash_on_delivery',
                        orderId: 'COD_TEST_' + Date.now(),
                        userId: 'user_003',
                        customerPhone: '+919876543210',
                        customerEmail: 'test@example.com',
                        customerName: 'Test User',
                        billingAddress: {
                            name: 'Test User',
                            street: '123 Test St',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400001',
                            country: 'India'
                        },
                        shippingAddress: {
                            name: 'Test User',
                            street: '123 Test St',
                            city: 'Mumbai',
                            state: 'Maharashtra',
                            pincode: '400001',
                            country: 'India',
                            phone: '+919876543210'
                        }
                    })
                });
                
                const paymentData = await response.json();
                
                if (paymentData.success) {
                    showStatus('codStatus', `
                        <strong>Cash on Delivery Order Created!</strong><br>
                        Order ID: ${paymentData.data.orderId}<br>
                        Amount: ‚Çπ${paymentData.data.amount}<br>
                        Status: ${paymentData.data.status}<br>
                        <em>No payment gateway needed for COD!</em>
                    `, 'success');
                } else {
                    showStatus('codStatus', `COD order creation failed: ${paymentData.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('codStatus', 'Error: ' + error.message, 'error');
            } finally {
                setButtonLoading('codBtn', false);
            }
        }

        async function testGSTCalculation() {
            setButtonLoading('gstBtn', true);
            showStatus('gstStatus', 'Calculating GST...', 'info');
            
            try {
                // Test intra-state GST
                const intraStateResponse = await fetch(`${API_BASE}/api/gst/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 1000,
                        gstRate: 18,
                        isInterState: false
                    })
                });
                
                const intraStateData = await intraStateResponse.json();
                
                // Test inter-state GST
                const interStateResponse = await fetch(`${API_BASE}/api/gst/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 1000,
                        gstRate: 18,
                        isInterState: true
                    })
                });
                
                const interStateData = await interStateResponse.json();
                
                if (intraStateData.success && interStateData.success) {
                    showStatus('gstStatus', `
                        <strong>GST Calculation Results:</strong><br><br>
                        <strong>Intra-state (Same State):</strong><br>
                        Taxable Amount: ‚Çπ${intraStateData.data.taxableAmount}<br>
                        CGST (9%): ‚Çπ${intraStateData.data.cgst}<br>
                        SGST (9%): ‚Çπ${intraStateData.data.sgst}<br>
                        Total GST: ‚Çπ${intraStateData.data.gstAmount}<br><br>
                        <strong>Inter-state (Different States):</strong><br>
                        Taxable Amount: ‚Çπ${interStateData.data.taxableAmount}<br>
                        IGST (18%): ‚Çπ${interStateData.data.igst}<br>
                        Total GST: ‚Çπ${interStateData.data.gstAmount}
                    `, 'success');
                } else {
                    showStatus('gstStatus', 'GST calculation failed', 'error');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showStatus('gstStatus', 'Error: ' + error.message, 'error');
            } finally {
                setButtonLoading('gstBtn', false);
            }
        }

        async function confirmPayment(paymentId, razorpayResponse, statusElementId) {
            showStatus(statusElementId, 'Confirming payment...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/payments/confirm`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentId: paymentId,
                        paymentMethod: 'card',
                        paymentData: {
                            razorpayOrderId: razorpayResponse.razorpay_order_id,
                            razorpayPaymentId: razorpayResponse.razorpay_payment_id,
                            razorpaySignature: razorpayResponse.razorpay_signature
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(statusElementId, `
                        <strong>üéâ Payment Successful!</strong><br>
                        Payment ID: ${result.data.paymentId}<br>
                        Order ID: ${result.data.orderId}<br>
                        Status: ${result.data.status}<br>
                        <em>Payment confirmed and order updated!</em>
                    `, 'success');
                } else {
                    showStatus(statusElementId, `Payment confirmation failed: ${result.message}`, 'error');
                }
                
            } catch (error) {
                console.error('Confirmation error:', error);
                showStatus(statusElementId, 'Payment confirmation failed!', 'error');
            }
        }

        // Check if server is running
        window.onload = async function() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                console.log('‚úÖ Server is running:', data);
            } catch (error) {
                console.error('‚ùå Server is not running:', error);
                alert('‚ö†Ô∏è Make sure your payment API server is running on http://localhost:3000');
            }
        };
    </script>
</body>
</html>
